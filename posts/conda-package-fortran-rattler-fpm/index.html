<!doctype html><html lang=en><head><title>Creating a Conda package from Fortran using fpm and rattler-build · Sam Harrison
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta http-equiv=Content-Security-Policy content="upgrade-insecure-requests; block-all-mixed-content; default-src 'self'; child-src 'self'; font-src 'self' https://fonts.gstatic.com https://cdn.jsdelivr.net/; form-action 'self'; frame-src 'self' https://utteranc.es; img-src 'self' https://storage.ko-fi.com https://samharrison7.goatcounter.com/count; object-src 'none'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com/ https://cdn.jsdelivr.net/; script-src 'self' 'unsafe-inline' https://gc.zgo.at https://storage.ko-fi.com https://cdn.jsdelivr.net https://utteranc.es; connect-src 'self' https://samharrison7.goatcounter.com/count;"><meta name=author content="Sam Harrison"><meta name=description content="How to create a Conda package from Fortran code using the Fortran Package Manager (fpm) and rattler-build"><meta name=keywords content="environmental scientist,environmental modelling,research software,blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://samharrison.science/posts/conda-package-fortran-rattler-fpm/rattler-build.png"><meta name=twitter:title content="Creating a Conda package from Fortran using fpm and rattler-build"><meta name=twitter:description content="How to create a Conda package from Fortran code using the Fortran Package Manager (fpm) and rattler-build"><meta property="og:url" content="https://samharrison.science/posts/conda-package-fortran-rattler-fpm/"><meta property="og:site_name" content="Sam Harrison"><meta property="og:title" content="Creating a Conda package from Fortran using fpm and rattler-build"><meta property="og:description" content="How to create a Conda package from Fortran code using the Fortran Package Manager (fpm) and rattler-build"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-02T20:11:48+00:00"><meta property="article:modified_time" content="2024-11-02T20:11:48+00:00"><meta property="article:tag" content="Conda"><meta property="article:tag" content="Fortran"><meta property="article:tag" content="Fpm"><meta property="article:tag" content="Rattler-Build"><meta property="article:tag" content="Pixi"><meta property="og:image" content="https://samharrison.science/posts/conda-package-fortran-rattler-fpm/rattler-build.png"><link rel=canonical href=https://samharrison.science/posts/conda-package-fortran-rattler-fpm/><link rel=preload href=/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.aa5ef26fa979d6793724ae2dbd71efa94fd16cb1c5c7db3b6651f21f9892a5fd.css integrity="sha256-ql7yb6l51nk3JK4tvXHvqU/RbLHFx9s7ZlHyH5iSpf0=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=stylesheet href=/scss/override.min.6240859aa8ee939a6a00894c1f5d26b7d034a33df2928b1fca4aa26ed939e8fb.css integrity="sha256-YkCFmqjuk5pqAIlMH10mt9A0oz3ykosfykqibtk56Ps=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/images/favicon.svg sizes=any><link rel=icon type=image/png href=/images/favicon32.png sizes=32x32><link rel=icon type=image/png href=/images/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><img class=header-avatar src=/images/sam-header.jpg>
<a class=navigation-title href=/>Sam Harrison
</a><input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/my-research/>My Research</a></li><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/contact/>Contact</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://samharrison.science/posts/conda-package-fortran-rattler-fpm/>Creating a Conda package from Fortran using fpm and rattler-build</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2024-11-02T20:11:48Z>2 November 2024
</time></span><span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
10-minute read</span></div><div class=tags><span class=tag><a href=/tags/conda/>conda</a>
</span><span class=tag><a href=/tags/fortran/>fortran</a>
</span><span class=tag><a href=/tags/fpm/>fpm</a>
</span><span class=tag><a href=/tags/rattler-build/>rattler-build</a>
</span><span class=tag><a href=/tags/pixi/>pixi</a></span></div></div></header><div><p>A while ago, I wrote a <a href=/posts/conda-package-fortran-python/>post on how to create a Conda package from Fortran and Python code</a>. Though the main point of the post was to explore including Fortran code in Python, I also delved into Conda build as a way of building Conda packages. There is now a new kid on the block - <a href=https://prefix-dev.github.io/rattler-build/latest/ target=_blank>rattler-build</a> - which offers a much faster and cleaner build experience for building Conda packages. I thought it was time for a blog post on that.</p><p>At the same time, the <a href=https://fpm.fortran-lang.org/ target=_blank>Fortran Package Manager (fpm)</a> is maturing and becoming the de facto way of managing Fortran projects and packages. <strong>Using fpm alongside rattler-build is a streamlined way of easily creating a Conda package for Fortran code</strong>, demonstrating the power that this modern tooling offers to what is often (incorrectly) perceived as a legacy language.</p><p>And seeing as we&rsquo;re diving into rattler-build, which is made by <a href=https://prefix.dev target=_blank>Prefix</a>, the lovely folk who also develop the <a href=https://pixi.sh/latest/ target=_blank>Pixi package manager</a>, it seems entirely appropriate to use Pixi as we go through this demo too.</p><div class="notice info"><div class=notice-title><i class="fa-solid fa-exclamation-circle" aria-hidden=true></i>Pre requisites</div><div class=notice-content>There is a fair bit of assumed knowledge in this article. In particular, you should be familiar with Conda packages and general principles of package and environment management. A bit of experience writing and building Fortran would also help.</div></div><h2 id=how-it-all-fits-together-aka-why-two-package-managers>How it all fits together (aka, why two package managers?)
<a class=heading-link href=#how-it-all-fits-together-aka-why-two-package-managers><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>You might have noticed that I mentioned two package managers above - fpm and Pixi. Fpm is a package manager to deal with pure Fortran projects, and can do neat things like pull in external Fortran packages by providing (GitHub) links to their source code. Pixi, on the other hand, is completely language agnostic, like the Conda packages that it can install. In this demo, I use fpm to setup a project with the Fortran source code. You could easily use another Fortran build tool or a standalone Fortran compiler to do this, but hopefully by the end of the post, you will see the simplicity that fpm brings. Pixi is used to test out the installation of the Conda package that we create, as well as installing rattler-build and fpm. So, in summary:</p><ul><li>Fpm is used to setup and build the Fortran project, including installing an external Fortran library</li><li>rattler-build is used to build the Fortran project into a Conda package by calling fpm as the build script</li><li>Pixi is used to test out the package, and install rattler-build and fpm.</li></ul><p>This is perhaps a bit over-the-top for the toy project here, but it sets the stage for how you might want to manage larger Fortran or multilingual projects.</p><div class="notice warning"><div class=notice-title><i class="fa-solid fa-exclamation-triangle" aria-hidden=true></i>Rattler build in pixi?</div><div class=notice-content>Prefix intend to integrate rattler-build into Pixi via a <code>pixi build</code> command. By the time you read this article, that might have already happened, so check out the <a href=https://pixi.sh target=_blank>Pixi docs</a> to see!</div></div><h2 id=getting-set-up>Getting set up
<a class=heading-link href=#getting-set-up><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Firstly, head over to <a href=https://pixi.sh/latest/#installation target=_blank>Pixi&rsquo;s docs</a> to install Pixi. Now, use Pixi to install ratter-build globally:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=command>pixi global install rattler-build
</span></code></pre></div><h2 id=creating-the-fortran-project>Creating the Fortran project
<a class=heading-link href=#creating-the-fortran-project><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>It&rsquo;s just turned November as I write this, so what better project to create than a command line script that tells me how many days it is until Christmas?!</p><p>To do this, we will install fpm by creating a Pixi project in which to do so:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=command>pixi init days-until-xmas 
</span><span class=command>cd days-until-xmas
</span><span class=command>pixi add fpm
</span></code></pre></div><p>Note that by default, Pixi tries to find the package in the conda-forge channel. Neat! To check that fpm has been installed correctly, we can check its version, either by using <code>pixi run</code> to run the <code>fpm</code> command in this environment - <code>pixi run fpm --version</code> - or by activating the environment and starting a new shell there&mldr;</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=command>pixi shell
</span></code></pre></div><p>&mldr;and then running fpm:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=custom>(days-until-xmas) $ </span>fpm --version
</code></pre></div><p>We also need a Fortran compiler, and if you don&rsquo;t already have one installed, you can install GFortran from conda-forge using Pixi by running <code>pixi add gfortran</code> (if you have activated the environment by starting a new shell, <code>exit</code> this first).</p><p>Note that fpm also requires Git to be installed. Again, this can be installed at the same time as installing fpm by running <code>pixi add git</code>.</p><p>Now we can use fpm to create the Fortran project. By default, fpm (like Pixi) creates a new directory when you create a new project. You can disable that by using the <code>--backfill</code> command, but to do so, we must first step outside of the <code>days-until-xmas</code> directory:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=custom>(days-until-xmas) $ </span>cd ..
<span class=custom>(days-until-xmas) $ </span>fpm new days-until-xmas --backfill
<span class=custom>(days-until-xmas) $ </span>cd days-until-xmas
</code></pre></div><p>Fpm creates an <code>fpm.toml</code> file and a few other default files, so alongside the <code>pixi.toml</code> and <code>pixi.lock</code> files that Pixi creates, your <code>days-until-xmas</code> directory should now look like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── app
</span></span><span style=display:flex><span>│   └── main.f90
</span></span><span style=display:flex><span>├── fpm.toml
</span></span><span style=display:flex><span>├── pixi.lock
</span></span><span style=display:flex><span>├── pixi.toml
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>├── src
</span></span><span style=display:flex><span>│   └── days-until-xmas.f90
</span></span><span style=display:flex><span>└── test
</span></span><span style=display:flex><span>    └── check.f90
</span></span></code></pre></div><p>Have a look in the <code>fpm.toml</code> to get a feeling of the metadata that fpm requires, and check out the <a href=https://fpm.fortran-lang.org/spec/manifest.html target=_blank>fpm manifest reference</a> for full details of what information can be provided via this file.</p><h2 id=writing-our-app>Writing our app
<a class=heading-link href=#writing-our-app><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>If you look inside the <code>src/days-until-xmas.f90</code> and <code>app/main.f90</code> files, you will see a simple &ldquo;Hello world&rdquo;-type app that fpm has created by default. We can test this out to see how fpm works:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=custom>(days-until-xmas) $ </span>fpm run
</code></pre></div><p>You should see (after some compilation output) &ldquo;Hello, days-until-xmas!&rdquo; printed to your console. During this command, fpm has built the <code>src/days-until-xmas.f90</code> file into a static library <code>libdays-until-xmas.a</code>, compiled an executable from <code>main.f90</code> that calls this library, and then run the executable. This is the beauty of fpm: abstracting away the complexities of building and running Fortran code using sensible defaults and simple commands.</p><p>It gets even better if we want to use external libraries. Here, we want to calculate the number of days until Christmas, so let&rsquo;s use an external Fortran package, <a href=https://github.com/wavebitscientific/datetime-fortran target=_blank>datetime-fortran</a>, to make it easier. This package is fpm-compatible (it has an <code>fpm.toml</code> file), meaning that we can easily specify that our project depends on it by adding the following to the bottom of our <code>fpm.toml</code> file:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[dependencies]
</span></span><span style=display:flex><span>datetime.git = <span style=color:#a50>&#34;https://github.com/wavebitscientific/datetime-fortran&#34;</span>
</span></span></code></pre></div><p>Now, if we run <code>fpm run</code> again, fpm also retrieves datetime-fortran from GitHub and compiles it into a static library, ready for use in our app.</p><p>You might have noticed the presence of a new directory, <code>build</code>. This is created by fpm and is where the compiled libraries and executables are stored. Have a look inside for a feeling of how fpm works. If you&rsquo;re intending to version control your project via Git, you will probably want to add this <code>build</code> directory to the <code>.gitignore</code> file (that Pixi has already added a couple of things to).</p><p>Now let&rsquo;s write our app, using the datetime-fortran library. In <code>src/days-until-xmas.f90</code>, we write:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fortran data-lang=fortran><span style=display:flex><span><span style=color:#00a>module</span><span style=color:#bbb> </span>days_until_xmas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>use</span><span style=color:#bbb> </span>datetime_module,<span style=color:#bbb> </span><span style=color:#00a>only</span>:<span style=color:#bbb> </span>datetime,<span style=color:#bbb> </span>timedelta<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>implicit</span><span style=color:#bbb> </span><span style=color:#00a>none</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>private</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>public</span><span style=color:#bbb> </span><span style=color:#00a>::</span><span style=color:#bbb> </span>get_days_until_xmas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>contains</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>function</span><span style=color:#bbb> </span>get_days_until_xmas()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#aaa;font-style:italic>!! Function that returns the number of days until Christmas
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#aaa;font-style:italic>!! as an integer
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#bbb>    </span><span style=color:#00a>type</span>(datetime)<span style=color:#bbb> </span><span style=color:#00a>::</span><span style=color:#bbb> </span>current_date<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>type</span>(datetime)<span style=color:#bbb> </span><span style=color:#00a>::</span><span style=color:#bbb> </span>xmas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>type</span>(timedelta)<span style=color:#bbb> </span><span style=color:#00a>::</span><span style=color:#bbb> </span>date_delta<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#00a>integer</span><span style=color:#bbb> </span><span style=color:#00a>::</span><span style=color:#bbb> </span>get_days_until_xmas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#aaa;font-style:italic>! Get the current date
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#bbb>    </span>current_date<span style=color:#bbb> </span>=<span style=color:#bbb> </span>current_date%now()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#aaa;font-style:italic>! Get Christmas day this year
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#bbb>    </span>xmas<span style=color:#bbb> </span>=<span style=color:#bbb> </span>datetime(current_date%getYear(),<span style=color:#bbb> </span><span style=color:#099>12</span>,<span style=color:#bbb> </span><span style=color:#099>25</span>)<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#aaa;font-style:italic>! Difference between now and Christmas
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#bbb>    </span>date_delta<span style=color:#bbb> </span>=<span style=color:#bbb> </span>xmas<span style=color:#bbb> </span>-<span style=color:#bbb> </span>current_date<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span><span style=color:#aaa;font-style:italic>! Get the number of days from this difference
</span></span></span><span style=display:flex><span><span style=color:#aaa;font-style:italic></span><span style=color:#bbb>    </span>get_days_until_xmas<span style=color:#bbb> </span>=<span style=color:#bbb> </span>date_delta%getDays()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>end</span><span style=color:#bbb> </span><span style=color:#00a>function</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>end</span><span style=color:#bbb> </span><span style=color:#00a>module</span><span style=color:#bbb> </span>days_until_xmas<span style=color:#bbb>
</span></span></span></code></pre></div><p>In <code>app/main.f90</code>, we write:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fortran data-lang=fortran><span style=display:flex><span><span style=color:#00a>program</span><span style=color:#bbb> </span>main<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>use</span><span style=color:#bbb> </span>days_until_xmas,<span style=color:#bbb> </span><span style=color:#00a>only</span>:<span style=color:#bbb> </span>get_days_until_xmas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>implicit</span><span style=color:#bbb> </span><span style=color:#00a>none</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#00a>print</span><span style=color:#bbb> </span>*,<span style=color:#bbb> </span><span style=color:#a50>&#39;Number of days until Christmas:&#39;</span>,<span style=color:#bbb> </span>get_days_until_xmas()<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#00a>end</span><span style=color:#bbb> </span><span style=color:#00a>program</span><span style=color:#bbb> </span>main<span style=color:#bbb>
</span></span></span></code></pre></div><p>Now we can test that our program functions created. It is 2nd November as I write this, and so there should be 52 days until Christmas:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=custom>(days-until-xmas) $ </span>fpm run<span class=output>
days-until-xmas.f90                    done.
libdays-until-xmas.a                   done.
main.f90                               done.
days-until-xmas                        done.
[100%] Project compiled successfully.
 Number of days until Christmas:          52
</span></code></pre></div><p>Our app is complete! Now we need to write a recipe so that rattler-build knows how to build it.</p><h2 id=writing-a-rattler-build-recipe>Writing a rattler-build recipe
<a class=heading-link href=#writing-a-rattler-build-recipe><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Rattler-build works in a similar way to conda-build: You specify a <code>recipe.yaml</code> file, and rattler-build builds a package using the instructions provided in that. The <code>recipe.yaml</code> file is similar, but not identitical to, the conda-forge schema. The <a href=https://prefix-dev.github.io/rattler-build/latest/highlevel/ target=_blank>Prefix docs</a> give a good intro.</p><p>It&rsquo;s up to you where you place your recipe, but it can&rsquo;t be in the same directory as the directory the build outputs to, which by default is <code>output</code>. A common practice is to have a separate <code>recipe</code> folder to place your recipe in. As we&rsquo;re done interacting with fpm for the moment (and therefore the Pixi environment), you can <code>exit</code> out of the Pixi shell.</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=command>mkdir recipe
</span><span class=command>touch recipe/recipe.yaml
</span></code></pre></div><p>Use whatever editor you like to add the following recipe to that file. We&rsquo;ll go through the contents in a moment.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#1e90ff;font-weight:700>package</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#1e90ff;font-weight:700>name</span>:<span style=color:#bbb> </span>days-until-xmas<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#1e90ff;font-weight:700>version</span>:<span style=color:#bbb> </span><span style=color:#099>1.0.0</span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#1e90ff;font-weight:700>source</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#1e90ff;font-weight:700>path</span>:<span style=color:#bbb> </span>..<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#1e90ff;font-weight:700>build</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#1e90ff;font-weight:700>script</span>:<span style=color:#bbb> </span>fpm install --prefix=${PREFIX}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb></span><span style=color:#1e90ff;font-weight:700>requirements</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>  </span><span style=color:#1e90ff;font-weight:700>build</span>:<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ${{ compiler(&#39;fortran&#39;) }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ${{ compiler (&#39;c&#39;) }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- ${{ compiler (&#39;cxx&#39;) }}<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- git<span style=color:#bbb>
</span></span></span><span style=display:flex><span><span style=color:#bbb>    </span>- fpm<span style=color:#bbb>
</span></span></span></code></pre></div><p>The <code>package</code> section provides useful metadata about our package. The <code>source</code> section tells rattler-build where our package is (we could specify a URL here instead). The <code>build</code> section tells rattler-build how to build the package. This is where we link up rattler-build with fpm, by using fpm within our build script to compile the Fortran code. We tell fpm to install this compiled code in <code>${PREFIX}</code>, which is the root directory of our built package.</p><p>The <code>requirements</code> section is where we tell rattler-build what packages we need to build and run the package. The recommended way of specifying compilers is to use the <code>${{ compiler('lang') }}</code> template function. This takes care of figuring out the runtime dependencies instead of having to manually add libraries like <code>libgfortran</code> to the <code>host</code> section of <code>requirements</code>. Because of this, we only need to specify requirements in the <code>build</code> section. We need a Fortran, C and C++ compiler, the latter two for the datetime-fortran library. By default, rattler-build will use GNU compilers for these. See the <a href=https://prefix-dev.github.io/rattler-build/latest/compilers/ target=_blank>rattler-build docs</a> for info on how to control which compiler and version is used.</p><div class="notice tip"><div class=notice-title><i class="fa-solid fa-lightbulb" aria-hidden=true></i>Tests</div><div class=notice-content>It is good practice to write tests! We&rsquo;ve glossed over this here, but really we should have written a few tests in the Fortran source code (fpm has functionality for running tests) and specified that they be run when building of package via the <code>test</code> section (which could be as simple as running <code>fpm test</code>).</div></div><h2 id=building-and-installing-the-package>Building and installing the package
<a class=heading-link href=#building-and-installing-the-package><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>We can now use rattler-build to build the package:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=command>rattler-build build --recipe recipe/recipe.yaml
</span></code></pre></div><p>Those of you that are used to conda-build will be astonished at how fast rattler-build is!</p><p>Rattler-build places the built package by default in the <code>output</code> directory. The full path to the package is given somewhere near the end of the build output. Copy this to the clipboard so that we can test installing it.</p><p>We can test the installation using anything that installs Conda packages, such as Conda, Mamba or Pixi. Seeing as we&rsquo;ve been using Pixi here, let&rsquo;s create a test Pixi project to install our package into:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=command>cd ..
</span><span class=command>pixi init test-days-until-xmas
</span><span class=command>cd test-days-until-xmas
</span></code></pre></div><p>Now we can install our package by calling <code>pixi add</code> on the path to the package:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=command>pixi add /path/to/package/output/linux-64/days-until-xmas-1.0.0-hb0f4dca_0.conda
</span></code></pre></div><p>Change the <code>/path/to/package...</code> path to that which you just copied to the clipboard. Providing the package installed correctly, we can now test it by running the <code>days-until-xmas</code> command:</p><div class="highlight command"><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span class=command>pixi run days-until-xmas</span><span class=output>
 Number of days until Christmas:          52
</span></code></pre></div><h2 id=next-steps>Next steps
<a class=heading-link href=#next-steps><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>You now have a shiny new functioning Conda package! Naturally, the next logical step would be to upload this to an online repository like Anaconda. We won&rsquo;t do this in this article, other than to mention that rattler-build has a very useful <a href=https://prefix-dev.github.io/rattler-build/latest/authentication_and_upload/#uploading-packages target=_blank><code>rattler-build upload</code> command</a> to take care of this task.</p><h2 id=final-words>Final words
<a class=heading-link href=#final-words><i class="fa-solid fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>I hope that you have found this post useful! I have placed a copy of the scripts that I created in this post on Codeberg*, so if you simply want to test the steps above without creating your own app, feel free to clone this and have a play around:</p><a href=https://codeberg.org/samharrison7/days-until-xmas class=button target=_blank><i class="fa fa-code fa-fw"></i>Get the code</a><p>*Like GitHub, but open-source - because why should you host open-source software on a closed-source service?</p></div><footer><span class=mr1>Found this post useful?</span>
<script type=text/javascript src=https://storage.ko-fi.com/cdn/widget/Widget_2.js></script><script type=text/javascript>kofiwidget2.init("Buy me a coffee","#29abe0","B0B1ACSFJ"),kofiwidget2.draw()</script><h3>Comments</h3><div id=utterances-light><script src=https://utteranc.es/client.js repo=samharrison7/samharrison-hugo issue-term=pathname label=comment theme=preferred-color-scheme crossorigin=anonymous async></script></div><div id=utterances-dark><script src=https://utteranc.es/client.js repo=samharrison7/samharrison-hugo issue-term=pathname label=comment theme=github-dark crossorigin=anonymous async></script></div></footer></article><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></section></div><footer class=footer><section class=container>©
2022 -
2024
Sam Harrison
·
Powered by <a href=https://gohugo.io/>Hugo</a> & lovingly adapted from the <a href=https://github.com/luizdepra/hugo-coder/>Coder</a> theme
·
<a href=https://samharrison.science//about>About this site.</a></section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script><script data-goatcounter=https://samharrison7.goatcounter.com/count async src=//gc.zgo.at/count.js></script></body></html>